<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Donation Overlay</title>

<style>
body {
  height: 100vh;
  margin: 0;
  overflow: hidden;
  background: rgba(0, 0, 0, 0);
  font-family: 'Segoe UI', sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* CENTER SCREEN */
#alertBox {
  display: none;
  flex-direction: column;
  align-items: center;
  text-shadow: 0px 0px 1px #000, 0px 0px 2px #000, 0px 0px 3px #000, 0px 0px 4px #000, 0px 0px 5px #000;
}

/* IMAGE */
#gif {
  width: 300px;
}

/* TEXT CONTAINER */
.textContent {
  display: flex;
  width: 100%;
  justify-content: center;
  flex-direction: column;
  align-items: center;
}

/* MAIN LINE */
.thankLine {
  margin: 10px 10px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 46px;
  font-weight: 700;
  color: white;
  gap: 10px;
}

/* Name */
#name {
  font-size: 46px;
  font-weight: 800;
  color: #ffc107;
}

/* Amount */
#amount {
  font-size: 46px;
  font-weight: 900;
  color: #ffc107;
  margin-top: 10px;
}

/* Sub message */
#message {
  font-size: 25px;
  color: #f0f0f0;
}

/* Letter Wiggle Animation */
@keyframes letterWiggle {
  0%   { transform: translateY(0px) rotate(0deg); }
  25%  { transform: translateY(-2px) rotate(-6deg); }
  50%  { transform: translateY(0px) rotate(6deg); }
  75%  { transform: translateY(-4px) rotate(-3deg); }
  100% { transform: translateY(0px) rotate(0deg); }
}

.wiggle span {
  display: inline-block;
  animation: letterWiggle 0.7s ease-in-out infinite;
}

/* Confetti canvas */
#confettiCanvas {
  position: fixed;
  top: 0;
  left: 0;
  pointer-events: none;
  display: none;
}
</style>
</head>

<body>
<canvas id="confettiCanvas"></canvas>

<div id="alertBox">
  <img id="gif" src="alert.gif">

  <div class="textContent">
    
    <div class="thankLine">
      <span id="name"></span> 
      tipped
      <span id="amount"></span>
    </div>
    <div id="message"></div>
  </div>

</div>

<audio id="alertSound" src="alert.mp3" preload="auto"></audio>
<audio id="ttsPlayer" preload="auto"></audio>

<script>
const canvas = document.getElementById("confettiCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let confettiPieces = [];
let confettiActive = false;

/* ================= LETTER SPLIT FUNCTION ================= */
function applyWiggle(element) {
  const text = element.innerText;
  element.innerHTML = "";

  text.split("").forEach((char, index) => {
    const span = document.createElement("span");
    span.innerText = char;
    span.style.animationDelay = (index * 0.05) + "s";
    element.appendChild(span);
  });

  element.classList.add("wiggle");
}

/* ================= CONFETTI ================= */

function startConfetti() {
  confettiActive = true;
  canvas.style.display = "block";
  confettiPieces = [];

  for (let i = 0; i < 150; i++) {
    confettiPieces.push({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      size: Math.random() * 8 + 4,
      speed: Math.random() * 3 + 2,
      color: `hsl(${Math.random()*360},100%,50%)`
    });
  }

  requestAnimationFrame(drawConfetti);
}

function stopConfetti() {
  confettiActive = false;
  canvas.style.display = "none";
}

function drawConfetti() {
  if (!confettiActive) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  confettiPieces.forEach(p => {
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x, p.y, p.size, p.size);
    p.y += p.speed;
    if (p.y > canvas.height) p.y = -10;
  });

  requestAnimationFrame(drawConfetti);
}

/* ================= ALERT LOGIC ================= */

async function checkAlert() {
  try {
    const res = await fetch("/current-alert");
    const data = await res.json();

    if (data.active) {
      showAlert(data.name, data.amount);
    }
  } catch(e){}
}

function showAlert(name, amount) {
  const box = document.getElementById("alertBox");
  const nameDiv = document.getElementById("name");
  const amountDiv = document.getElementById("amount");
  const messageDiv = document.getElementById("message");
  const alertSound = document.getElementById("alertSound");
  const tts = document.getElementById("ttsPlayer");

  nameDiv.innerText = name;
  amountDiv.innerText = "â‚¹ " + amount;
  messageDiv.innerText = "Thank you so much for your support!";

  applyWiggle(nameDiv);
  applyWiggle(amountDiv);

  box.style.display = "flex";

  startConfetti();

  alertSound.play().catch(()=>{});

  alertSound.onended = () => {
    tts.src = "tts.mp3?cache=" + Date.now();
    tts.play().catch(()=>{});
  };

  tts.onended = () => {
    box.style.display = "none";
    stopConfetti();
  };
}

setInterval(checkAlert, 2000);
</script>

</body>
</html>